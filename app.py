import streamlit as st
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from dotenv import load_dotenv

load_dotenv()

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å®šç¾©
PROMPT_BY_DURATION = """ã‚ãªãŸã¯20å¹´ã®çµŒé¨“ã‚’æŒã¤æ—…è¡Œãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚è±Šå¯Œãªæ—…è¡ŒçµŒé¨“ã‹ã‚‰ã€åŠ¹ç‡çš„ã§å®Ÿè·µçš„ãªæŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒå¾—æ„ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã«åŸºã¥ã„ã¦ã€æ—…è¡Œã«å¿…è¦ãªæŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ—…è¡Œæƒ…å ±ã€‘
- æ—…è¡Œå…ˆ: {destination}
- {duration_info}
- æ—…ã®ã‚¿ã‚¤ãƒ—: {trip_type}
- è¿½åŠ æƒ…å ±: {additional_info}

ã€æŒ‡ç¤ºã€‘
1. æ—…è¡Œæ—¥æ•°ã«åˆã‚ã›ãŸåŠ¹ç‡çš„ãªæŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„
2. å¿…é ˆã‚¢ã‚¤ãƒ†ãƒ ã€æ¨å¥¨ã‚¢ã‚¤ãƒ†ãƒ ã€ã‚ã‚‹ã¨ä¾¿åˆ©ãªã‚¢ã‚¤ãƒ†ãƒ ã«åˆ†é¡ã—ã¦ãã ã•ã„
3. å„æŒã¡ç‰©ã®æ¨å¥¨æ•°é‡ã¾ãŸã¯é‡ã‚’æ˜ç¢ºã«è¨˜è¼‰ã—ã¦ãã ã•ã„
4. ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆè¡£é¡ã€è¡›ç”Ÿç”¨å“ã€é›»å­æ©Ÿå™¨ã€æ—…è¡Œç”¨å“ã€ãã®ä»–ï¼‰ã«åˆ†é¡ã—ã¦è¡¨ç¤ºã—ã¦ãã ã•ã„
5. æ—…è¡Œæ—¥æ•°ã‹ã‚‰äºˆæƒ³ã•ã‚Œã‚‹ç§»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„æ´»å‹•ã«åˆã‚ã›ãŸæŒã¡ç‰©ã‚’ææ¡ˆã—ã¦ãã ã•ã„
6. æ—…ã®ç¨®é¡ã«ç‰¹åŒ–ã—ãŸå¿…é ˆã‚¢ã‚¤ãƒ†ãƒ ã®èª¬æ˜ã‚‚å«ã‚ã¦ãã ã•ã„
7. è·ç‰©ç®¡ç†ã®ã‚³ãƒ„ã‚„ãƒ‘ãƒƒã‚­ãƒ³ã‚°ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚‚å«ã‚ã¦ãã ã•ã„

å®Ÿç”¨çš„ã§ã€ç„¡é§„ã®ãªã„æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚"""

PROMPT_BY_SEASON = """ã‚ãªãŸã¯æ°—è±¡å­¦ã®çŸ¥è­˜ã‚’æŒã¤å¤©æ°—å°‚é–€ã®æ—…è¡Œãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã§ã™ã€‚å­£ç¯€ã”ã¨ã®æ°—è±¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è©³ã—ãã€ãã®æ™‚æœŸã®å¤©æ°—å¤‰åŒ–ã«å¯¾å¿œã—ãŸæœ€é©ãªæŒã¡ç‰©ã‚’ææ¡ˆã™ã‚‹ã“ã¨ãŒå¾—æ„ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã«åŸºã¥ã„ã¦ã€æ—…è¡Œã«å¿…è¦ãªæŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ—…è¡Œæƒ…å ±ã€‘
- æ—…è¡Œå…ˆ: {destination}
- å­£ç¯€: {season}
- æ—…ã®ã‚¿ã‚¤ãƒ—: {trip_type}
- è¿½åŠ æƒ…å ±: {additional_info}

ã€æŒ‡ç¤ºã€‘
1. {season}ã®æ°—è±¡ç‰¹æ€§ã¨äºˆæƒ³ã•ã‚Œã‚‹æ°—è±¡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸ã¾ãˆãŸæŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„
2. ãã®å­£ç¯€ç‰¹æœ‰ã®æ°—è±¡ãƒªã‚¹ã‚¯ï¼ˆé›¨ã€é›ªã€é¢¨ã€ç´«å¤–ç·šãªã©ï¼‰ã«å¯¾å¿œã™ã‚‹æŒã¡ç‰©ã‚’å¼·èª¿ã—ã¦ãã ã•ã„
3. æ—…è¡Œå…ˆã®æ°—å€™ã¨{season}ã®æ°—è±¡ã‚’çµ„ã¿åˆã‚ã›ãŸé©åˆ‡ãªè¡£é¡ã‚’ææ¡ˆã—ã¦ãã ã•ã„
4. å„æŒã¡ç‰©ã¨æ°—è±¡æ¡ä»¶ã®é–¢é€£æ€§ã‚’èª¬æ˜ã—ã¦ãã ã•ã„
5. ã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼ˆè¡£é¡ãƒ»é˜²å…·ã€å¤©æ°—å¯¾ç­–ã€è¡›ç”Ÿç”¨å“ã€é›»å­æ©Ÿå™¨ã€ãã®ä»–ï¼‰ã«åˆ†é¡ã—ã¦è¡¨ç¤ºã—ã¦ãã ã•ã„
6. å¤©æ°—æ€¥å¤‰æ™‚ã®å¯¾ç­–ã‚„å¿œæ€¥ã‚°ãƒƒã‚ºã‚‚å«ã‚ã¦ãã ã•ã„
7. æ—…è¡Œä¸­ã®å¤©æ°—äºˆå ±ç¢ºèªæ–¹æ³•ã‚„ã‚¢ãƒ—ãƒªã®åˆ©ç”¨ã«ã¤ã„ã¦ã‚‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„

æ°—è±¡çŸ¥è­˜ã«åŸºã¥ã„ãŸã€å­£ç¯€ã«æœ€é©åŒ–ã—ãŸæŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚"""


def generate_packing_list(
    destination: str,
    selection_mode: str,
    trip_type: str,
    additional_info: str,
    duration_days: int = None,
    season: str = None
) -> str:
    """
    å…¥åŠ›æƒ…å ±ã«åŸºã¥ã„ã¦ã€AIãŒæ¨å¥¨ã™ã‚‹æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    
    Args:
        destination: æ—…è¡Œå…ˆ
        selection_mode: "å®¿æ³Šæ—¥æ•°ã§è¨ˆç”»" ã¾ãŸã¯ "å­£ç¯€ã§è¨ˆç”»"
        trip_type: æ—…ã®ã‚¿ã‚¤ãƒ—
        additional_info: è¿½åŠ æƒ…å ±
        duration_days: å®¿æ³Šæ—¥æ•°ï¼ˆselection_modeãŒ"å®¿æ³Šæ—¥æ•°ã§è¨ˆç”»"ã®å ´åˆï¼‰
        season: å­£ç¯€ï¼ˆselection_modeãŒ"å­£ç¯€ã§è¨ˆç”»"ã®å ´åˆï¼‰
    
    Returns:
        str: LLMãŒç”Ÿæˆã—ãŸæŒã¡ç‰©ãƒªã‚¹ãƒˆ
    """
    llm = ChatOpenAI(model="gpt-4o-mini", temperature=0.7)
    
    # é¸æŠãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨å¼•æ•°ã‚’æº–å‚™
    if selection_mode == "å®¿æ³Šæ—¥æ•°ã§è¨ˆç”»":
        prompt_template = ChatPromptTemplate.from_template(PROMPT_BY_DURATION)
        invoke_params = {
            "destination": destination,
            "duration_info": f"å®¿æ³Šæ—¥æ•°ã¯{duration_days}æ—¥",
            "trip_type": trip_type,
            "additional_info": additional_info if additional_info else "ãªã—"
        }
    else:
        prompt_template = ChatPromptTemplate.from_template(PROMPT_BY_SEASON)
        invoke_params = {
            "destination": destination,
            "season": season,
            "trip_type": trip_type,
            "additional_info": additional_info if additional_info else "ãªã—"
        }
    
    # LLMå‘¼ã³å‡ºã—ï¼ˆé‡è¤‡æ’é™¤ï¼‰
    response = (prompt_template | llm).invoke(invoke_params)
    
    return response.content


st.title("ğŸ§³ æ—…è¡ŒæŒã¡ç‰©ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼")

st.write("æ—…è¡Œã«å¿…è¦ãªæŒã¡ç‰©ã‚’AIãŒãŠã™ã™ã‚ã—ã¦ãã‚Œã¾ã™ã€‚")
st.write("å®¿æ³Šæ—¥æ•°ã¾ãŸã¯å­£ç¯€ã‚’é¸æŠã—ã¦ã€ã•ã‚‰ã«è©³ç´°æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

# é¸æŠãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
selection_mode = st.radio(
    "è¨ˆç”»æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
    ["å®¿æ³Šæ—¥æ•°ã§è¨ˆç”»", "å­£ç¯€ã§è¨ˆç”»"]
)

st.divider()

# å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®é…ç½®
col1, col2 = st.columns(2)

with col1:
    if selection_mode == "å®¿æ³Šæ—¥æ•°ã§è¨ˆç”»":
        days = st.number_input(
            "å®¿æ³Šæ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ—¥ï¼‰",
            min_value=1,
            max_value=365,
            value=3
        )
        mode_info = f"å®¿æ³Šæ—¥æ•°: {days}æ—¥"
    else:
        season = st.selectbox(
            "å­£ç¯€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
            ["æ˜¥", "å¤", "ç§‹", "å†¬"]
        )
        mode_info = f"å­£ç¯€: {season}"

with col2:
    destination = st.text_input(
        "æ—…è¡Œå…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šäº¬éƒ½ã€æ²–ç¸„ï¼‰",
        placeholder="ä¾‹ï¼šäº¬éƒ½"
    )
    trip_type = st.selectbox(
        "æ—…ã®ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚",
        ["ãƒ“ã‚¸ãƒã‚¹å‡ºå¼µ", "å®¶æ—æ—…è¡Œ", "å‹äººã¨ã®æ—…", "ä¸€äººæ—…", "ãƒãƒãƒ ãƒ¼ãƒ³"]
    )

# è¿½åŠ ã®è©³ç´°æƒ…å ±
st.divider()
st.subheader("è¿½åŠ æƒ…å ±ï¼ˆä»»æ„ï¼‰")

additional_info = st.text_area(
    "ãã®ä»–ã€å‚è€ƒã«ãªã‚‹æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã€ä½“èª¿ãªã©ï¼‰",
    placeholder="ä¾‹ï¼šãƒˆãƒ¬ãƒƒã‚­ãƒ³ã‚°ã‚’äºˆå®šã—ã¦ã„ã¾ã™",
    height=100
)

st.divider()

# å®Ÿè¡Œãƒœã‚¿ãƒ³
if st.button("ğŸ“‹ æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ", use_container_width=True):
    if not destination:
        st.error("æ—…è¡Œå…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
    else:
        try:
            # ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤ºã—ãªãŒã‚‰å‡¦ç†
            with st.spinner("ğŸ¤” æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆä¸­..."):
                result = generate_packing_list(
                    destination=destination,
                    selection_mode=selection_mode,
                    trip_type=trip_type,
                    additional_info=additional_info,
                    duration_days=days if selection_mode == "å®¿æ³Šæ—¥æ•°ã§è¨ˆç”»" else None,
                    season=season if selection_mode == "å­£ç¯€ã§è¨ˆç”»" else None
                )
            
            # çµæœã‚’è¡¨ç¤º
            st.divider()
            st.success("âœ… æŒã¡ç‰©ãƒªã‚¹ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼")
            st.markdown(result)
            
            # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ç”¨ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã«ä¿å­˜
            st.session_state.generated_list = result
            
        except Exception as e:
            st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
            st.info("OpenAI APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")